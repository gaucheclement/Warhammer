<script>
    var MainMenu = function (CharGen) {
        var oThat = {};
        oThat.stepName = "Menu";
        oThat.desc = function () {
            return ''
        };
        oThat.title = function () {
            return 'Générateur de personnage'
        };
        oThat.initAction = function () {

        };

        oThat.otherAction = false; /*function (el) {
            el.html('Options');
            el.off('click').on('click', function () {
                $('.all_panel').hide();
                $('.two_part_panel').show();
                CharGen.showPanel(0, Option(CharGen));
            });
        };*/

        oThat.randomAction = false;
        oThat.show = function () {
            $('.all_panel').show();
            $('.two_part_panel').hide();
            var stepList = [
                {
                   stepName: "Continuer", onClick: function () {
                       $('.all_panel').hide();
                       $('.two_part_panel').show();
                       CharGen.showPanel(0, Menu(CharGen));
                   },
                   isDisabled: function (i, el) {
                       return !CharGen.character
                   }
               },
               Menu(CharGen, 'normal'),
               Menu(CharGen, 'libre'),
               {
                   stepName: "Nouveau (aléatoire)", onClick: function () {
                       var i = 0;
                       var max = 4;
                       Menu(CharGen, 'normal').createNewCharacter();
                       //CharGen.character.xp.max = 50000;
                       while (i < max) {
                           var step = CharGen.stepList[i++];
                           step.resetAction();
                           step.initAction();
                           step.randomAllAction();
                           if (i === 1) {
                               CharGen.character.setSpecie(CharGen.data.specie.allById[Helper.toId('Humains (Nordland)')]);
                           } else if (i === 2) {
                               CharGen.character.setCareerLevel(CharGen.data.careerLevel.allById[Helper.toId('Artisan|Apprenti Artisan')]);
                           }
                       }
                      CharGen.character.stepIndex = i;
                       $('.all_panel').hide();
                       $('.two_part_panel').show();
                       CharGen.showPanel(CharGen.character.stepIndex, CharGen.stepList[CharGen.character.stepIndex]);
                   }
               },
               {
                   stepName: "Charger", onClick: function () {
                       $("#load").dialog({
                           resizable: false,
                           height: "auto",
                           buttons: {
                               "Charger": async function () {
                                   var dial = $(this);
                                   const response = await fetch(Helper.googleURL + '?action=load&saveName=' + $('.code').val(),{
                                       redirect: "follow",
                                       method: "GET",
                                       headers: {
                                           "Content-Type": "text/plain;charset=utf-8",
                                       },
                                   })
                                   /*var save = localStorage.getItem('save');
                                   var saveName = $('.code').val();
                                   if (save === null) {
                                       save = {};
                                   } else {
                                       save = JSON.parse(save);
                                   }*/
                                   if (response/*typeof save[saveName] !== 'undefined'*/) {
                                       var data = /*save[saveName];*/await response.json();
                                       Menu(CharGen).createNewCharacter();
                                       CharGen.character.load(data);
                                       CharGen.saveName = $('.code').val();
                                       $('.all_panel').hide();
                                       $('.two_part_panel').show();
                                      if (CharGen.character.stepIndex === 8) {
                                           CharGen.showPanel(CharGen.character.stepIndex, CharGen.stepList[CharGen.character.stepIndex]);
                                       } else {
                                           CharGen.showPanel(0, Menu(CharGen));
                                       }
                                       dial.dialog("destroy");
                                   } else {
                                       alert('Ce personnage n\'existe pas.');
                                   }
                                   //google.script.run.withSuccessHandler().withUserObject(dial).load($('.code').val());
                               },
                               "Annuler": function () {
                                   $(this).dialog("destroy");
                               }
                           }
                       });
                   }
               },
               /* {
                     stepName: "Importer de Foundry", onClick: function () {
                         $("#load").dialog({
                             resizable: false,
                             height: "auto",
                             buttons: {
                                 "Importer": function () {
                                     var dial = $(this);
                                     Menu(CharGen, 'libre').createNewCharacter();
                                     CharGen.character = FoundryHelper.import(CharGen, $('.code').val());
                                     CharGen.character.stepIndex = -1;
                                     $('.all_panel').hide();
                                     $('.left_panel').show();
                                     $('.right_panel').show();
                                     CharGen.showPanel(8, CharGen.stepList[8]);
                                     dial.dialog("destroy");
                                 },
                                 "Annuler": function () {
                                     $(this).dialog("destroy");
                                 }
                             }
                         });
                     }
                 },*/
                Compendium(CharGen)
            ];
            Helper.generateMenu(stepList, null, $('.all_panel'),
                function (i, el) {
                    $('.all_panel').hide();
                    $('.two_part_panel').show();
                    if (el.createNewCharacter) {
                        el.createNewCharacter();
                    }
                    CharGen.showPanel(0, el);
                }
            );
        };
        return oThat;
    }
</script>