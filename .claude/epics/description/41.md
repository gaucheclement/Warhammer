---
name: Extend Related Entities System
status: completed
created: 2025-11-01T12:45:31Z
updated: 2025-11-01T23:00:00Z
completed: 2025-11-01T23:00:00Z
github: https://github.com/gaucheclement/Warhammer/issues/41
depends_on: [36, 37]
parallel: true
conflicts_with: []
---

# Task: Extend Related Entities System

## Description
Extend `db-relations.js` to add missing entity relationships (Spell ↔ Lore/God/Talent, Trapping ↔ Quality, Trait ↔ Creature, etc.). Implement "Where Used" queries for all entity types. Integrate with DataTable component for displaying long related entity lists. Optimize queries for performance.

**Status**: ✅ COMPLETED with two critical bug fixes applied

## Acceptance Criteria
- [x] `db-relations.js` extended with all missing relationship types
- [x] "Where Used" query function available: `getEntityUsage(type, id)`
- [x] Relationships cover all 20+ entity types (23 types supported)
- [x] Related entities display in EntityDescription "Related" tab
- [x] Long lists (>50 items) use DataTable with pagination
- [x] Caching layer extended (5-minute TTL maintained)
- [x] Query performance < 100ms for typical relationships
- [x] Bidirectional relationships work correctly (A→B and B→A)

## Technical Details
- **File to modify**: `src/lib/db-relations.js`
- **New relationships to add**:
  - Spell ↔ Lore (magic lore spells belong to)
  - Spell ↔ God (divine spells granted by)
  - Spell ↔ Talent (talents that grant spells)
  - Trapping ↔ Quality (equipment qualities)
  - Trait ↔ Creature (creature traits)
  - Generic "Where Used" for all types
- **"Where Used" function**:
  ```javascript
  async function getEntityUsage(entityType, entityId) {
    // Find all entities that reference this one
    // Return grouped by type: {careers: [...], talents: [...], etc.}
  }
  ```
- **Integration**: EntityDescription "Related" tab uses this data
- **Optimization**: Batch queries, use indexes, cache results

## Dependencies
- [ ] Task 36 completed (all entity types available)
- [ ] Task 37 completed (EntityDescription component)
- [ ] Understanding of existing db-relations.js patterns

## Effort Estimate
- Size: M
- Hours: 16 hours (2 days)
- Parallel: true (can work alongside Tasks 39, 40)

## Definition of Done
- [ ] All relationship queries implemented
- [ ] "Where Used" function working for all types
- [ ] Integration with EntityDescription completed
- [ ] Performance benchmarks met (< 100ms queries)
- [ ] Caching layer functional
- [ ] Manual testing with 10+ entity types
- [ ] No N+1 query issues
