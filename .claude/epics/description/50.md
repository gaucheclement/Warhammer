---
name: Refactoriser db-descriptions en composants Svelte
github: https://github.com/gaucheclement/Warhammer/issues/50
updated: 2025-11-02T20:31:41Z
---

# Issue #50: Refactoriser db-descriptions en composants Svelte

**Epic**: Description System Modernization
**Priority**: High
**Type**: Refactoring / Architecture
**Estimated Effort**: 3-4 jours

## Problème

Le code actuel dans `src/lib/db-descriptions.js` (2153 lignes) mélange JavaScript et HTML de manière non-Svelte :

### Problèmes actuels

1. **Construction de HTML par string concatenation**
   ```javascript
   desc += '<b>Compétences: </b><ul><li>' + items.join('</li><li>') + '</li></ul>'
   ```

2. **Utilisation de regexp pour manipuler HTML**
   ```javascript
   processedText = processedText.replace(regexp, (match, p1, p2) => {
     return p1 + '#' + (matches.length - 1) + '#' + p7
   })
   ```

3. **Injection de HTML via `{@html}` dans les composants**
   ```svelte
   {@html currentTabContent}
   ```

4. **Code difficile à maintenir**
   - Logique de génération HTML dispersée
   - Difficile à tester unitairement
   - Pas de type safety
   - Risques de sécurité XSS

### Impact

- **Maintenabilité**: Code complexe et fragile
- **Testing**: Difficile de tester la génération HTML
- **Performances**: Parsing HTML au runtime
- **Sécurité**: Injection HTML potentielle
- **DX**: Pas d'autocomplétion, pas de type checking

## Solution proposée

Refactoriser complètement le système en utilisant des composants Svelte natifs.

### Architecture cible

```
src/components/descriptions/
├── base/
│   ├── EntityLink.svelte       # Remplace <span class="showHelp">
│   ├── DescriptionSection.svelte
│   ├── DescriptionList.svelte
│   ├── RankIcon.svelte
│   └── StatTable.svelte
├── entities/
│   ├── CareerDescription.svelte
│   ├── TalentDescription.svelte
│   ├── SkillDescription.svelte
│   ├── SpellDescription.svelte
│   ├── CreatureDescription.svelte
│   └── ...
└── DescriptionRenderer.svelte  # Routeur de composants
```

### Changements dans db-descriptions.js

Au lieu de retourner du HTML:
```javascript
// ❌ AVANT
return '<b>Compétences: </b><ul><li>Athlétisme</li></ul>'
```

Retourner des données structurées:
```javascript
// ✅ APRÈS
return {
  sections: [
    {
      type: 'list',
      label: 'Compétences',
      items: [
        { id: 'athletisme', type: 'skill', label: 'Athlétisme' }
      ]
    }
  ]
}
```

### Composants de base

#### EntityLink.svelte
```svelte
<script>
  export let id;
  export let type;
  export let label;

  import { createEventDispatcher } from 'svelte';
  const dispatch = createEventDispatcher();
</script>

<button
  class="entity-link"
  on:click={() => dispatch('navigate', { type, id })}
>
  {label}
</button>
```

#### DescriptionList.svelte
```svelte
<script>
  import EntityLink from './EntityLink.svelte';

  export let label;
  export let items = [];
</script>

{#if items.length > 0}
  <div class="description-list">
    <strong>{label}:</strong>
    <ul>
      {#each items as item}
        <li>
          {#if item.type}
            <EntityLink {...item} on:navigate />
          {:else}
            {item.label}
          {/if}
        </li>
      {/each}
    </ul>
  </div>
{/if}
```

### Migration EntityDescription.svelte

```svelte
<!-- ❌ AVANT -->
<div class="entity-description__html-content">
  {@html currentTabContent}
</div>

<!-- ✅ APRÈS -->
<div class="entity-description__content">
  <DescriptionRenderer
    {entityType}
    {descriptionData}
    on:navigate={handleNavigate}
  />
</div>
```

## Plan de migration

### Phase 1: Composants de base
- [ ] Créer `EntityLink.svelte`
- [ ] Créer `DescriptionSection.svelte`
- [ ] Créer `DescriptionList.svelte`
- [ ] Créer `RankIcon.svelte`
- [ ] Créer `StatTable.svelte`

### Phase 2: Refactoriser db-descriptions.js
- [ ] Modifier `generateCareerDescription()` pour retourner données structurées
- [ ] Modifier `generateTalentDescription()`
- [ ] Modifier `generateSkillDescription()`
- [ ] Modifier `generateSpellDescription()`
- [ ] Modifier les autres générateurs (creature, trapping, etc.)
- [ ] Supprimer les fonctions de génération HTML (`showHelpText`, `toHtmlList`, etc.)

### Phase 3: Composants de description spécifiques
- [ ] Créer `CareerDescription.svelte`
- [ ] Créer `TalentDescription.svelte`
- [ ] Créer `SkillDescription.svelte`
- [ ] Créer `SpellDescription.svelte`
- [ ] Créer `CreatureDescription.svelte`
- [ ] Créer composants pour les autres types

### Phase 4: Intégration
- [ ] Créer `DescriptionRenderer.svelte` (routeur)
- [ ] Mettre à jour `EntityDescription.svelte`
- [ ] Supprimer le code de parsing HTML
- [ ] Mettre à jour les tests

### Phase 5: Validation
- [ ] Tous les tests passent à 100%
- [ ] Test manuel de chaque type d'entité
- [ ] Vérifier la navigation entre entités
- [ ] Vérifier les tooltips
- [ ] Test de performance

## Avantages attendus

1. **Maintenabilité**: Code Svelte idiomatique et modulaire
2. **Type Safety**: Structures de données typées avec JSDoc/TypeScript
3. **Testabilité**: Composants isolés testables unitairement
4. **Performance**: Pas de parsing HTML, réactivité Svelte native
5. **Sécurité**: Pas d'injection HTML possible
6. **Réutilisabilité**: Composants réutilisables dans toute l'app
7. **DX**: Autocomplétion, refactoring facilité

## Fichiers impactés

### À modifier
- `src/lib/db-descriptions.js` - Refactoriser pour retourner données
- `src/components/EntityDescription.svelte` - Utiliser nouveaux composants
- `src/lib/db-descriptions.test.js` - Adapter les tests

### À créer
- `src/components/descriptions/base/*.svelte` - Composants de base
- `src/components/descriptions/entities/*.svelte` - Composants spécifiques
- `src/components/descriptions/DescriptionRenderer.svelte` - Routeur

### À supprimer (progressivement)
- Fonctions de génération HTML dans db-descriptions.js
- Utilisation de `{@html}` dans EntityDescription.svelte

## Risques et mitigation

| Risque | Mitigation |
|--------|------------|
| Régression fonctionnelle | Tests exhaustifs à 100% avant merge |
| Changement de structure de données | Migration progressive, compatibilité temporaire |
| Effort important | Découpage en phases, validation à chaque phase |

## Définition de "Terminé"

- [ ] Tous les composants de base créés et testés
- [ ] db-descriptions.js retourne données structurées (pas HTML)
- [ ] Tous les types d'entités ont leur composant Svelte
- [ ] EntityDescription.svelte n'utilise plus `{@html}`
- [ ] Tous les tests passent à 100%
- [ ] Documentation mise à jour
- [ ] Validation manuelle complète
- [ ] Pas de régression de performance
