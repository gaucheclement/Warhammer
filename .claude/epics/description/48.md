---
name: Unify Data Layer Architecture - Merge data.js and dataStore.js
github: https://github.com/gaucheclement/Warhammer/issues/48
updated: 2025-11-02T16:08:35Z
---

# Issue #48: Unify Data Layer Architecture - Merge data.js and dataStore.js

**Epic**: Data Layer Consolidation
**Priority**: High
**Type**: Architecture / Refactoring
**Estimated Effort**: 2-3 days

## Problem Statement

The application currently has **two parallel data layer implementations** that are not integrated:

### Current State

1. **`src/stores/data.js`** (494 lines) - **ACTIVE**
   - ✅ Used by 23+ files across the application
   - ✅ Manages `officialData`, `customModifications`, `mergedData`, `characters`
   - ✅ Provides rich API: `modifyEntity`, `createCustomEntity`, `deleteModification`, etc.
   - ❌ **Does NOT parse entity references** (no EntityReference objects)
   - ❌ Uses simple `generateIdsForEntities` without full `transformData` pipeline
   - ❌ No validation or data quality reporting

2. **`src/stores/dataStore.js`** (433 lines) - **DORMANT**
   - ✅ Implements Issue #47: Entity reference parsing with `transformData`
   - ✅ Parses references into `EntityReference` objects
   - ✅ Validates and reports data quality
   - ✅ Provides `dataQueries` utility (used only by `navigation.js`)
   - ❌ **Never initialized** - `initDataStore()` is never called
   - ❌ Missing `characters` store
   - ❌ Missing helper functions: `modifyEntity`, `createCustomEntity`, etc.

### Impact

- **Functional**: Entity references are stored as plain strings/numbers instead of structured `EntityReference` objects
- **Development**: Duplicated code and confusion about which system to use
- **Maintenance**: Bug fixes and features must be applied to both systems
- **Performance**: Missing optimization opportunities from Issue #47
- **Data Quality**: No validation or reporting on reference resolution

## Goals

Create a unified, pérenne (sustainable) data layer architecture that:

1. ✅ Uses Issue #47's `transformData` pipeline for all data loading
2. ✅ Parses all entity references into `EntityReference` objects
3. ✅ Preserves all functionality from `data.js` (characters, modifications, helpers)
4. ✅ Provides validation and data quality reporting
5. ✅ Maintains backward compatibility with existing imports
6. ✅ Eliminates code duplication

## Technical Analysis

### Dependencies

```
App.svelte
  └─> stores/data.js (initializeDataStores)
        ├─> lib/db.js (getAllFromTable)
        ├─> lib/dataMerger.js (mergeData)
        └─> lib/db-id-generator.js (generateIdsForEntities)

navigation.js
  └─> stores/dataStore.js (dataQueries)  ⚠️ NEVER INITIALIZED

stores/dataStore.js (DORMANT)
  ├─> lib/db-loader.js (transformData, loadIntoIndexedDB, formatReport)
  ├─> lib/db-id-generator.js
  └─> stores/customModifications.js
```

### Files Importing from data.js (23 total)

- `App.svelte`, `Browse.svelte`, `Creator.svelte`, `CharacterSheet.svelte`
- `CharacterList.svelte`, `Home.svelte`, `Admin.svelte`
- `AdminDashboard.svelte`, `AdminEditData.svelte`, `AdminReviewContributions.svelte`
- `ExportButton.svelte`, `ImportCharacter.svelte`, `AdvancementDialog.svelte`
- `lib/dataOperations.js`, `lib/adminExport.js`, `lib/validators.js`
- `lib/exportModifications.js`, `lib/importModifications.js`, `lib/resetUtils.js`
- And more...

### Key Features to Preserve

From `data.js`:
- ✅ `officialData` store
- ✅ `customModifications` store with localStorage persistence
- ✅ `characters` store with IndexedDB persistence
- ✅ `mergedData` derived store
- ✅ `isDataLoading` and `dataError` state
- ✅ Helper functions: `modifyEntity`, `createCustomEntity`, `deleteModification`
- ✅ Counting functions: `getCustomModificationsCount`
- ✅ `saveCustomModifications`, `resetCustomModifications`

From `dataStore.js`:
- ✅ Issue #47 `transformData` pipeline
- ✅ EntityReference parsing and validation
- ✅ Data quality reporting
- ✅ `dataQueries` utility object
- ✅ `optimizedMergedData` store

## Proposed Solution

### Architecture Decision

**Merge into `data.js`** (not `dataStore.js`) because:

1. ✅ Already used by 23+ files - minimal migration
2. ✅ Has complete API surface (characters, helpers, etc.)
3. ✅ Just needs to adopt `transformData` from Issue #47
4. ✅ Maintains backward compatibility

### Migration Strategy

**Phase 1: Integrate transformData into data.js**
- Import `transformData`, `loadIntoIndexedDB`, `formatReport` from `db-loader.js`
- Replace simple `generateIdsForEntities` with full `transformData` pipeline
- Add validation and reporting logs
- **Result**: All entity references are now `EntityReference` objects

**Phase 2: Port dataQueries and optimizations**
- Add `dataQueries` utility from `dataStore.js`
- Add `optimizedMergedData` derived store
- Update `navigation.js` to import from `data.js` instead

**Phase 3: Testing and validation**
- Run all existing tests
- Verify entity references are parsed correctly
- Check data quality reports
- Test all CRUD operations

**Phase 4: Cleanup**
- Archive `dataStore.js` → `dataStore.js.bak`
- Update documentation
- Remove `initData.js` remnants (already done)

## Implementation Streams

### Stream A: Core Integration (Priority: Critical)

**Goal**: Integrate Issue #47's `transformData` pipeline into `data.js`

**Tasks**:
1. Update `seedIndexedDB()` in `data.js` to use `transformData`
   - Import from `lib/db-loader.js`
   - Replace direct `generateIdsForEntities` call
   - Add `formatReport` logging
2. Update `loadOfficialData()` to handle EntityReference objects
3. Add validation error handling
4. Test entity reference parsing with species, careers, skills

**Acceptance Criteria**:
- ✅ All entities loaded via `transformData` pipeline
- ✅ Entity references are `EntityReference` objects (have `.id`, `.label`, `.entityType`)
- ✅ Validation report logged on startup
- ✅ No regression in existing functionality

**Files Modified**:
- `src/stores/data.js`

---

### Stream B: Port Utilities and Optimizations (Priority: Medium)

**Goal**: Add `dataQueries` and optimization features from `dataStore.js`

**Tasks**:
1. Port `dataQueries` object to `data.js`
   - `getEntity(entityType, entityId)`
   - `getEntitiesByType(entityType)`
   - `searchEntities(entityType, query)`
   - `getCount(entityType)`
   - `getAllStats()`
2. Add `optimizedMergedData` derived store
3. Update `navigation.js` import
   - Change from `stores/dataStore.js` to `stores/data.js`
   - Verify navigation label resolution works

**Acceptance Criteria**:
- ✅ `dataQueries` utility available in `data.js`
- ✅ `navigation.js` uses unified data layer
- ✅ Entity labels resolved correctly in navigation history

**Files Modified**:
- `src/stores/data.js`
- `src/stores/navigation.js`

---

### Stream C: Testing and Validation (Priority: High)

**Goal**: Ensure unified system works correctly

**Tasks**:
1. Run all existing tests
   - `npm test -- db-loader.test.js`
   - `npm test -- db-id-generator.test.js`
   - `npm test -- db-relations.test.js`
   - `npm test -- db-descriptions-new.test.js`
2. Manual testing checklist:
   - Load application and check console for validation report
   - Browse entities: verify IDs are strings (e.g., `"humains-reiklander"`)
   - Click entity: verify description modal loads correctly
   - Check entity references in descriptions are clickable
   - Create custom modification: verify merge works
   - Navigate between entities: verify history works
3. Create integration test for unified data layer
4. Document validation report format

**Acceptance Criteria**:
- ✅ All automated tests pass
- ✅ Manual testing checklist complete
- ✅ No console errors on startup
- ✅ Entity navigation works end-to-end

**Files Created**:
- `src/lib/__tests__/unified-data-layer.test.js`

---

### Stream D: Cleanup and Documentation (Priority: Low)

**Goal**: Remove deprecated code and update docs

**Tasks**:
1. Archive `dataStore.js`
   - Rename to `dataStore.js.bak`
   - Add comment explaining it's superseded by unified `data.js`
2. Remove any remaining references to `initData.js`
3. Update architecture documentation
   - Document EntityReference format
   - Document validation report
   - Document dataQueries API
4. Add JSDoc comments for new functions
5. Create migration guide for future contributors

**Acceptance Criteria**:
- ✅ `dataStore.js` archived
- ✅ No references to old systems
- ✅ Documentation updated
- ✅ Migration guide created

**Files Modified**:
- `src/stores/dataStore.js` → `src/stores/dataStore.js.bak`
- `docs/ARCHITECTURE.md`
- `.claude/epics/description/48-migration-guide.md`

## Testing Strategy

### Unit Tests

- `db-loader.test.js`: Verify transformData pipeline
- `db-id-generator.test.js`: Verify ID generation with objects (eyes, hairs)
- `db-relations.test.js`: Verify EntityReference parsing
- `data.test.js` (new): Test unified store

### Integration Tests

- Load full dataset and verify all entity types
- Test customModifications merge with EntityReferences
- Test character creation and updates
- Test navigation with parsed references

### Manual Testing

1. Clear browser data: `localStorage.clear()`, `indexedDB.deleteDatabase('WarhammerDB')`
2. Reload application
3. Check console for:
   - ✅ "Using db-loader for ID generation and reference parsing"
   - ✅ Transformation report showing resolved/unresolved references
   - ✅ No errors
4. Browse entities and verify string IDs
5. Test entity navigation and reference clicking

## Risks and Mitigation

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Breaking changes in EntityReference format | Medium | High | Comprehensive testing, backward compatibility layer |
| Performance regression with transformData | Low | Medium | Benchmark before/after, optimize if needed |
| Existing code depends on plain reference format | Medium | High | Gradual migration, maintain compatibility |
| Loss of functionality during merge | Low | High | Port all features, extensive testing |

## Success Metrics

- ✅ Zero duplicate data loading systems
- ✅ 100% of entity references are EntityReference objects
- ✅ Validation report shows <5% unresolved references
- ✅ All 23+ dependent files work without modification
- ✅ Navigation history shows entity labels (not just IDs)
- ✅ No console errors on application startup
- ✅ All automated tests pass

## Dependencies

**Blocks**:
- None

**Blocked By**:
- None

**Related Issues**:
- Issue #47: Entity Reference Parsing and Validation (provides transformData)
- Issue #46: Browse Modal Entity ID 0 (fixed by proper ID generation)

## Rollout Plan

1. **Development**: Complete all 4 streams
2. **Testing**: Run full test suite + manual QA
3. **Staging**: Deploy to test environment
4. **Production**: Deploy with rollback plan ready
5. **Monitoring**: Watch for errors in first 24 hours

## Rollback Plan

If critical issues arise:

1. Revert `data.js` changes
2. Re-enable simple `generateIdsForEntities`
3. Clear browser IndexedDB
4. Redeploy previous version

## Notes

- This is a **foundational refactoring** that will improve data quality and maintainability
- The effort is justified by eliminating technical debt and enabling future features
- EntityReference objects will unlock advanced features (auto-linking, validation, etc.)

## Timeline

- **Stream A**: 1 day
- **Stream B**: 0.5 days
- **Stream C**: 0.5 days
- **Stream D**: 0.5 days
- **Total**: 2.5 days

---

**Created**: 2025-11-02
**Status**: Ready for Implementation
**Assignee**: TBD
