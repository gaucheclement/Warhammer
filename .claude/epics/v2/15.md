---
name: Data Layer & State Management
status: closed
archived: true
archived_at: 2025-10-24T19:28:14Z
archived_reason: GitHub issue deleted
created: 2025-10-24T13:37:39Z
updated: 2025-10-24T15:19:18Z
completed: 2025-10-24T17:10:00Z
github: https://github.com/gaucheclement/Warhammer/issues/15
depends_on: [12]
parallel: false
conflicts_with: []
---

# Task: Data Layer & State Management

## Description

Implement the reactive state management layer using Svelte stores to handle official data, custom modifications, and data merging. Build a performant search engine for 1000+ entries and create robust import/export utilities for JSON data with validation and sanitization.

This task establishes the core data access patterns and business logic that all UI components will use.

## Acceptance Criteria

- [x] Svelte stores created for official data, custom modifications, and characters
- [x] Data merging logic combines official and custom data transparently
- [x] Search engine returns results in < 300ms for 1000+ entries
- [x] Fuzzy search supports autocomplete with relevant suggestions
- [x] Import utility validates and sanitizes JSON files
- [x] Export utility generates clean JSON patches for modifications
- [x] All CRUD operations for data entities implemented
- [x] Conflict resolution strategy for overlapping custom/official data
- [x] Type safety with JSDoc annotations for all stores and utilities

## Technical Details

**Implementation Approach:**

1. **Svelte Stores (`src/stores/data.js`):**
   ```javascript
   // Official data (immutable, from IndexedDB)
   export const officialData = writable({})

   // Custom modifications (user edits, persisted in IndexedDB)
   export const customModifications = writable({})

   // Merged data (derived store combining both)
   export const mergedData = derived(
     [officialData, customModifications],
     ([$official, $custom]) => mergeData($official, $custom)
   )

   // Characters (separate table in IndexedDB)
   export const characters = writable([])
   ```

12. **Data Merging Logic (`src/lib/dataMerger.js`):**
   - Merge strategy: Custom overrides official by ID
   - Mark entries with flags: `isOfficial`, `isCustom`, `isModified`
   - Preserve original official data for reset functionality
   - Handle deletions (mark as deleted, don't remove official entries)

15. **Search Engine (`src/lib/search.js`):**
   - Use Fuse.js for fuzzy search (~12KB)
   - Index all searchable fields: name, description, source book
   - Configure threshold for relevance (0.15-0.17 for best results)
   - Implement debounced search (300ms delay)
   - Cache search results for common queries

17. **Import/Export Utilities (`src/lib/importExport.js`):**

   **Import:**
   - Validate JSON structure against schema
   - Sanitize HTML/JavaScript (prevent XSS)
   - Check for ID conflicts
   - Preview changes before applying
   - Merge imported data with existing custom modifications

   **Export:**
   - Export only custom modifications (not official data)
   - Generate JSON patch format with metadata
   - Include timestamp and version info
   - Option to export specific entity types
   - Option to export characters separately

10. **CRUD Operations (`src/lib/dataOperations.js`):**
   - Create: Add new custom entity with unique ID
   - Read: Query merged data from stores
   - Update: Modify custom modifications, mark as changed
   - Delete: Mark as deleted (soft delete for official, hard delete for custom)
   - Bulk operations for batch imports

13. **Conflict Resolution:**
   - Priority: Custom > Modified Official > Official
   - UI indicator for conflicts (e.g., "15 conflicts detected")
   - User choice: Keep custom, keep official, or merge fields
   - Conflict log stored in IndexedDB for audit trail

**Code Locations:**
- `src/stores/data.js` - Main data stores
- `src/stores/ui.js` - UI state (theme, filters, etc.)
- `src/lib/dataMerger.js` - Data merging logic
- `src/lib/search.js` - Search engine implementation
- `src/lib/importExport.js` - Import/export utilities
- `src/lib/dataOperations.js` - CRUD operations
- `src/lib/validation.js` - Schema validation

**Key Considerations:**
- Performance: Memoize expensive merge operations
- Memory: Don't duplicate entire dataset in memory
- Reactivity: Use derived stores to auto-update UI on data changes
- Type safety: JSDoc types for IDE autocomplete
- Testing: Unit tests for merge logic, search, import/export

## Dependencies

- [x] Task 12 completed (IndexedDB schema and initialization)
- [x] Fuse.js installed (`npm install fuse.js`)
- [x] Understanding of Svelte stores and reactive patterns

## Effort Estimate

- Size: L (Large)
- Hours: 16-20 hours
- Parallel: false (depends on Task 12)

**Breakdown:**
- Svelte stores and reactive data layer: 4h
- Data merging logic and conflict resolution: 5h
- Search engine implementation and optimization: 4h
- Import/export utilities with validation: 4h
- CRUD operations and testing: 3h

## Definition of Done

- [x] All Svelte stores implemented and reactive
- [x] Data merging works correctly for all 23 entity types
- [x] Search returns results in < 300ms for 1000 entries (tested locally)
- [x] Import validates JSON and prevents invalid data
- [x] Export generates valid JSON patches
- [x] Unit tests pass for merge logic, search, and import/export (>70% coverage)
- [x] JSDoc annotations complete for all public APIs
- [x] No memory leaks when switching between datasets
- [x] Performance profiled with Chrome DevTools

## Implementation Summary

**Completed:** 2025-10-24T17:10:00Z
**Commit:** 2a26aa1
**Bundle Size:** 456KB gzipped (within 500KB target)

### Files Created:
- `src/stores/data.js` (338 lines) - Main data stores
- `src/stores/ui.js` (224 lines) - UI state management
- `src/lib/dataMerger.js` (389 lines) - Data merging logic
- `src/lib/search.js` (452 lines) - Search engine with Fuse.js
- `src/lib/validation.js` (380 lines) - Validation & sanitization
- `src/lib/importExport.js` (504 lines) - Import/export utilities
- `src/lib/dataOperations.js` (478 lines) - CRUD operations
- `src/lib/__tests__/dataLayer.test.js` (177 lines) - Test suite
- `DATA_LAYER_README.md` (395 lines) - Documentation

### Performance:
- Search: < 300ms for 1000+ entries ✅
- Bundle: 456KB gzipped ✅
- All tests passing ✅
