---
epic: v2
status: completed
archived: true
archived_at: 2025-11-02T09:42:10Z
archived_reason: GitHub issue deleted
created: 2025-10-25T11:30:00Z
updated: 2025-10-25T06:38:55Z
completed: 2025-10-25T06:38:55Z
priority: medium
depends_on: []
parallel: true
github: https://github.com/gaucheclement/Warhammer/issues/22
synced: 2025-10-25T06:38:55Z
---

# Intégrer la structure de données riche dans db.js

## Overview
Le fichier `db.js` du projet warhammer-v2 définit un schéma IndexedDB simple et plat, mais n'exploite pas la structure de données riche et les relations complexes définies dans les fichiers HTML du projet original.

## Problème Actuel

### db.js (epic-v2/warhammer-v2/src/lib/db.js)
Actuellement, db.js est très minimaliste:
- Schéma plat avec 23 tables simples
- Helpers basiques (getAllFromTable, searchByName, getById)
- Aucune logique métier
- Aucune relation entre entités
- Aucune transformation de données

### Structure riche dans les fichiers HTML (racine du projet)
Les fichiers HTML définissent une architecture complète:
- **DataFunctions.html** - Framework pour créer des objets de données structurés
- **DataCareer.html** - Carrières avec relations vers careerLevel, class, skills, talents, trappings
- **DataTalent.html** - Talents avec specs, addSkill, addTalent, maxHelp, testHelp
- **DataSkill.html** - Compétences avec characteristic, specs, type (base/advanced)
- **DataSpell.html** - Sorts avec cn, range, target, duration, lore
- Et 18+ autres types similaires...

### Fonctionnalités manquantes dans db.js

#### 1. Relations entre objets
```javascript
// Dans DataCareer.html
el.getClass = function () { return this.class; }
(CharGen.data.careerLevel.allByCareer[elem.id]).forEach(...)
el.getSkills(true), el.getTalents(), el.getTrappings()
```

#### 2. Transformations et parsing
```javascript
// Dans DataFunctions.html
oThat.parseElems = function (el, match) {
  el.class = DataHelper.stringToElems(CharGen, el.class, el, 'class', true, match).data;
}
```

#### 3. Génération de descriptions
```javascript
// Chaque Data*.html a une méthode getDescription()
el.getDescription = function () {
  var res = {};
  if (elem.desc) {
    res['Info'] = DescriptionHelper.applyHelp(elem.desc, elem, labels);
  }
  // ... relations, traits, accès, etc.
}
```

#### 4. Spécialisations et options
```javascript
// Dans DataTalent.html et DataSkill.html
el.specs = el.specs ? el.specs.split(', ') : [];
el.canHaveSpec = true;
el.spec = '';
```

#### 5. Structure hiérarchique
```javascript
// DataFunctions génère automatiquement des arbres
oThat.generateTree = function (el) {
  var father = el.getLinkedFolder();
  father.children[father.children.length] = el;
}
```

## Solution Proposée

### Phase 1: Enrichir le schéma db.js
Ajouter les champs manquants dans le schéma Dexie:

```javascript
careers: 'id, name, class, *species, status, book, page, desc, rand, subRand',
talents: 'id, name, maxRank, tests, specs, addSkill, addTalent, book, page, desc',
skills: 'id, name, characteristic, type, advanced, specs, book, page, desc, example',
// etc.
```

### Phase 2: Ajouter des relations via indexes composés
```javascript
careerLevels: 'id, name, [career+level], level, status, book, page',
// Permet de faire: db.careerLevels.where('[career+level]').equals([careerId, level])
```

### Phase 3: Créer des helpers pour les relations
```javascript
// Nouveaux helpers dans db.js
export async function getCareerWithLevels(careerId) {
  const career = await db.careers.get(careerId);
  const levels = await db.careerLevels.where('career').equals(careerId).toArray();
  return { ...career, levels };
}

export async function getTalentWithRelations(talentId) {
  const talent = await db.talents.get(talentId);
  if (talent.addSkill) {
    talent.relatedSkill = await db.skills.get(talent.addSkill);
  }
  // etc.
}
```

### Phase 4: Implémenter les transformations
Porter la logique de DataHelper et DescriptionHelper:
```javascript
export function parseCareer(career) {
  // stringToElems logic
  career.classData = await db.classes.get(career.class);
  career.speciesData = await Promise.all(
    career.species.map(s => db.species.get(s))
  );
  return career;
}
```

### Phase 5: Méthodes de génération
```javascript
export async function generateCareerDescription(careerId) {
  const career = await getCareerWithLevels(careerId);
  // Logique de getDescription() depuis DataCareer.html
  return formattedDescription;
}
```

## Bénéfices

1. **Cohérence** - Le projet warhammer-v2 utilise la même structure que le projet original
2. **Relations** - Navigation facile entre objets liés (carrière → niveaux → talents/skills)
3. **Réutilisabilité** - Les transformations de données sont centralisées dans db.js
4. **Maintenabilité** - Une seule source de vérité pour la structure des données
5. **Performance** - IndexedDB avec indexes optimisés pour les requêtes relationnelles

## Fichiers Concernés

### À analyser (source de vérité)
- DataFunctions.html - Framework de base
- DataHelper.html - Helpers de transformation
- DescriptionHelper.html - Génération de descriptions
- Data*.html (23 fichiers) - Définitions des types

### À modifier
- epic-v2/warhammer-v2/src/lib/db.js - Enrichir le schéma et ajouter les helpers

### Nouveaux fichiers suggérés
- epic-v2/warhammer-v2/src/lib/db-relations.js - Helpers pour les relations
- epic-v2/warhammer-v2/src/lib/db-transforms.js - Transformations de données
- epic-v2/warhammer-v2/src/lib/db-descriptions.js - Génération de descriptions

## Acceptance Criteria

- [ ] Le schéma db.js inclut tous les champs des fichiers HTML
- [ ] Les relations entre objets sont implémentées (career ↔ careerLevel, talent ↔ skill, etc.)
- [ ] Les helpers de transformation sont portés depuis DataHelper.html
- [ ] Les méthodes getDescription() sont implémentées pour chaque type
- [ ] Les spécialisations (specs) sont gérées correctement
- [ ] La structure hiérarchique (folders/trees) est supportée
- [ ] Les tests valident les relations et transformations
- [ ] La documentation explique la structure de données enrichie

## Références

### Fichiers HTML structurant les données
```
DataFunctions.html   - createDataObject, getData, generateTree
DataHelper.html      - initData, stringToElems, bindElem
DataCareer.html      - career structure with class, levels, etc.
DataTalent.html      - talent structure with specs, addSkill
DataSkill.html       - skill structure with characteristic, specs
DataSpell.html       - spell structure with cn, range, lore
DataCareerLevel.html - career levels with skills, talents, trappings
```

### Exemples de données JSON sources
Les fichiers HTML chargent `CharGen.jData` qui contient les données brutes pour les 23 types.
