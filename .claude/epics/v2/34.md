---
github: https://github.com/gaucheclement/Warhammer/issues/34
title: "Audit: Vérifier la conformité avec le schéma v2 de la base de données"
status: in_progress
archived: true
archived_at: 2025-11-02T09:42:10Z
archived_reason: GitHub issue deleted
created: 2025-10-26T07:33:49Z
updated: 2025-10-26T07:33:49Z
labels:
  - bug
---

# Audit: Vérifier la conformité avec le schéma v2 de la base de données

## Description

Audit de l'utilisation du schéma v2 de la base de données dans l'application. Le schéma v2 utilise `label` au lieu de `name` pour les entités, mais plusieurs parties du code utilisent encore `name`.

## Référence

- Schéma v2: `warhammer-v2/docs/database-schema.md`
- Définition DB: `warhammer-v2/src/lib/db.js`

## Problèmes identifiés

### 1. Browse.svelte (src/routes/Browse.svelte)

**Ligne 193**: Utilise `item.name || item.title || 'Unnamed'`
```svelte
<h3 class="item-name">{item.name || item.title || 'Unnamed'}</h3>
```

**Ligne 200**: Utilise `item.name` dans aria-label
```svelte
aria-label="Edit {item.name || 'item'}"
```

**Impact**: Les noms des entités ne s'affichent pas correctement dans le navigateur Browse.

**Solution**: Remplacer `item.name` par `item.label` partout dans ce fichier.

---

### 2. db.js (src/lib/db.js)

**Ligne 177**: La fonction `searchByName` utilise `item.name`
```javascript
.filter(item => item.name && item.name.toLowerCase().includes(searchLower))
```

**Impact**: La recherche par nom ne fonctionne pas avec le schéma v2.

**Solution**: Remplacer `item.name` par `item.label`.

---

### 3. search.js (src/lib/search.js)

**Ligne 286-287**: Utilise `item.name` pour les suggestions
```javascript
if (item.name) {
  suggestions.add(item.name)
}
```

**Impact**: Les suggestions de recherche ne fonctionnent pas correctement.

**Solution**: Remplacer `item.name` par `item.label`.

---

### 4. Character.svelte (src/routes/Character.svelte)

**Ligne 145**: Utilise `item.name` pour l'équipement
```svelte
<div class="equipment-item">{item.name}</div>
```

**Impact**: Les noms d'équipement ne s'affichent pas.

**Solution**: Remplacer `item.name` par `item.label`.

---

### 5. Tests (src/lib/search.test.js et src/lib/__tests__/dataLayer.test.js)

Plusieurs références à `item.name` au lieu de `item.label` dans les assertions de tests.

**Impact**: Les tests peuvent échouer ou donner de faux positifs.

**Solution**: Mettre à jour tous les tests pour utiliser `item.label`.

---

## Champs potentiellement manquants dans Browse/Admin

### Analyse du schéma v2

Selon `database-schema.md`, tous les types d'entités incluent ces champs:

**Champs communs obligatoires:**
- `id` - Identifiant unique ✅
- `label` - Nom de l'entité ❌ (utilise `name`)
- `book` - Référence du livre source ❓
- `page` - Page du livre ❓
- `folder` - Organisation hiérarchique ❓
- `desc` - Description ❓

### Champs non affichés dans Browse.svelte

Le Browse n'affiche actuellement que:
- `name/title` (incorrect, devrait être `label`)
- `description` (ligne 208)
- Quelques méta-données spécifiques (class, cn)

**Champs manquants:**
- `book` - Source du contenu
- `page` - Numéro de page
- `folder` - Catégorisation
- Champs spécifiques selon le type (specs, max, test pour talents, etc.)

---

## Champs non exposés dans Admin

Le panneau Admin (`src/routes/Admin.svelte`) affiche uniquement:
- Statistiques de base (counts)
- Status d'initialisation
- Actions de maintenance

**Manquant:**
- Vue détaillée des entités
- Édition des métadonnées (book, page, folder)
- Gestion des relations entre entités

---

## Checklist des fichiers à auditer

### Priorité Haute (bloque l'affichage)
- [ ] `src/routes/Browse.svelte` - Affichage des entités
- [ ] `src/lib/db.js` - Fonction searchByName
- [ ] `src/lib/search.js` - Suggestions de recherche
- [ ] `src/routes/Character.svelte` - Affichage équipement

### Priorité Moyenne (fonctionnalités)
- [ ] `src/routes/Creator.svelte` - Vérifier les références aux entités
- [ ] `src/routes/Admin.svelte` - Ajouter vue détaillée des entités
- [ ] `src/components/wizard/*.svelte` - Vérifier tous les steps du wizard

### Priorité Basse (tests et qualité)
- [ ] `src/lib/search.test.js` - Mettre à jour les assertions
- [ ] `src/lib/__tests__/dataLayer.test.js` - Mettre à jour les assertions
- [ ] Tous les autres fichiers `.test.js`

---

## Plan d'action

1. **Phase 1: Correction des bugs critiques**
   - Remplacer `name` par `label` dans Browse, db.js, search.js
   - Tester l'affichage dans Browse après corrections

2. **Phase 2: Amélioration de l'affichage**
   - Ajouter les champs `book`, `page`, `folder` dans Browse
   - Afficher les champs spécifiques selon le type d'entité

3. **Phase 3: Admin et Creator**
   - Auditer Creator.svelte et les wizards
   - Améliorer Admin.svelte pour afficher/éditer les métadonnées

4. **Phase 4: Tests**
   - Mettre à jour tous les tests
   - Ajouter tests de régression pour le schéma v2

---

## Critères d'acceptance

- [ ] Tous les affichages utilisent `label` au lieu de `name`
- [ ] La recherche fonctionne correctement avec `label`
- [ ] Les métadonnées (book, page, folder) sont affichées dans Browse
- [ ] Les champs spécifiques à chaque type sont exposés
- [ ] Tous les tests passent avec le schéma v2
- [ ] Aucune régression sur les fonctionnalités existantes

---

## Notes techniques

**Migration v1 → v2:**
Le schéma définit une migration automatique de v1 à v2 (voir db.js lignes 19-46). Cependant, le code de l'application doit être mis à jour pour utiliser les nouveaux noms de champs.

**Compatibilité:**
Pour assurer une transition en douceur, on pourrait temporairement supporter les deux syntaxes:
```javascript
const displayName = item.label || item.name || 'Unnamed'
```

Mais à terme, seul `label` devrait être utilisé pour respecter le schéma v2.
